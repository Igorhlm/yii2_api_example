##Пример простого API на основе фреймворка Yii2 (basic) 

###Общие сведения
Демонстрационный проект - пример простого API ("библиотека").  
Реализована аутентификация на основе _JWT_ токенов,  
релизовано тестирование, 
реализована связь между моделями _User_ и _RefreshToken_ (как пример) и другое (см. сам проект).

Настройки _JWT_ заданы в _config/params.php_:  

    jwtSecret' => '2kTNZm42aP6Ye5sP8osJSovJhdkNftfsZATBuRnpr3pxIYWYHSsqAVKdsmVuvglG',  
  
    // TTL access токена (в секундах)  
    'accessTokenTime' => 60*2,  
  
    // TTL refresh токена (месяцы)  
    'refreshTokenTime' => 1,  
  
###Развернуть проект (сервер разработки фреймворка)

1. Клонировать проект 
  _git clone yii2_api_example    
клонирует проект в новую папку с именем репозитария в текущем каталоге  
_git clone yii2_api_example <папка на локальной машине>_  
клонирует проект в указанную папку

2. Открыть _config.php_ и удалить (закомментировать) конфигурацию для БД, где используется СУБД для _Docker`а_  

3. Перейти в папку с проектом, открыть терминал и запустить сервер разработки фреймворка  
   _php yii serve_  
   (предполагается, что порт _8080_, который по умолчанию использует сервер разработки _Yii2_ свободен;  
   если порт _8080_ по какой-либо причине занят, при запуске сервера необходимо указать другой порт, например _8000_:  
   _php yii serve -p 8000_  
   и при запросах использовать именно измененный порт)

4. Для установки необходимых пакетов выполнить  
   _composer install_ 

5. Используя какой-либо инструмент (_phpmyadmin_), создать БД с именем _yii2_api_example_  
   (предполагается, что cервер MySQL\MariaDB работает),  
   а также создать БД для тестирования (_yii2_api_example_test_)

6. Открыть еще один терминал в папке проекта и выполнить миграции  
_php yii migrate_  

7. После этого можно просмотреть документацию (_swagger_) и протестировать доступные методы, 
   открыв в браузере ссылку:   
   _http://localhost:8080/docs/index.html_    
   Для тестирования также можно воспользоваться _Insomnia_,  
   импортировав данные (см. в корне проекта файл _Insomnia_yii2_api_example.json_)

8. Для запуска тестов, в консоли:  
   а) остановить сервер разработки (CTRL+C)  
   б) запустить сервер для тестирования  _php tests/bin/yii serve_  
   в) выполнить миграции для тестовой БД   
      _php tests/bin/yii migrate_  
   г) сами тесты (_tests/GetBookCest.php_)  
      _php vendor/bin/codecept build_  
      _php vendor/bin/codecept run Api_  

###Развернуть проект (Docker)

Проект можно развернуть, используя _Docker_  
(конечно необходимо, чтобы и сам _Docker_ и средство оркестрации контейнеров _docker compose_  
были установлены на локальной машине)

1. Клонировать проект (см. выше)  

2. Открыть _config.php_ и удалить (закомментировать) конфигурацию для БД, где используется СУБД на хосте

3. Перейти в папку с проектом и выполнить  
   _docker-compose docker-compose.local.yml up -d_

4. Убедиться, что контейнеры работают:  
_docker ps_

5. Подключиться к контейнеру c проектом  
   _docker exec -it php_fpm-yii2-api-example bash_

6. Для установки необходимых пакетов выполнить  
   _composer install_

7. Выполнить миграции   
   _php yii migrate_

8. После этого можно просмотреть документацию (swagger) и протестировать доступные методы, открыв в браузере ссылку (порт _8888_):   
   _http://localhost:8888/docs/index.html_    
   Также можно воспользоваться _Insomnia_, импортировав данные (см. корень проекта)

9. Для подключения к БД и просмотра данных:
   _mariadb -u root -p --port=3366_   
   ("внутри" используется стандартный порт _3306_, "снаружи" - _3366_, см. _docker-compose.local.yml_, секцию _db_)  
   также можно подключиться к БД непосредственно из контейнера, используя стандартный порт _3306_)

###Примечания к проекту

__Полнота реализации__ В силу того, что проект демонстрационный, реализовано то что достаточно для демонстрации,  
остальное только обозначено или реализовано частично.    
Так, например, есть описание модели _Book_ (_Swagger_), но нет описания моделей _User_ и  _RefreshToken_   
(для демонстрации достаточно описания модели _Book_).  
Также - отсутствует реализация и описание контроллера _UserController_ и другое подобное.  
По той же причине (проект демонстрационный), проект содержит оба метода для обновления данных (и __PUT__ и  __PATCH__),
с учетом их особенностей

__Тестирование__ Если проект был развернут с использованием docker`а, то запуск тестов потребует соответствующих изменений   

__Модель Book__ Для демонстрации проверка длины поля _author_ модели _Book_ производится отдельной функцией  
(модель _Book_, функция _checkAuthorLength()_).  
Конечно можно производить валидацию поля _author_ аналогично полю _title_ (наименование книги),  
именно для демонстрации используется все-таки отдельная функция  

__Документация API - swagger.json__ Создать или обновить файл описания API (swagger.json):  
_php ./vendor/bin/openapi ./modules/api/modules/v1  -o ./web/docs/swagger.json --legacy_

__Запросы к API__ Запросы к API можно выполнять, используя:  
1. страницу документации (_http://localhost:8080/docs/index.html_  
или, если проект развернут с использованием _Docker`а_ _http://localhost:8888/docs/index.html_)
2. _Insomnia_ (можно импортировать данные из файла _Insomnia_yii2_api_example.json_, см. в корне проекта)
3. _curl_, пример запроса (получение списка книг, встроенный сервера разработки) см. ниже  
_curl --request GET \  
--url 'http://localhost:8080/api/v1/book \  
--header 'Accept: application/json, */*; q=0.01' \  
--header 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjgwODAiLCJzdWIiOjIsImlhdCI6MTczNjUxOTczNywibmJmIjoxNzM2NTE5NzM3LCJleHAiOjE3MzY1MTk4NTd9.2VwxU-sQAfm4flE52Q9ADm8bU3es5gFxfGdx7Mgt8UE' \  
--header 'Content-Type: application/json; charset=UTF-8'_  
